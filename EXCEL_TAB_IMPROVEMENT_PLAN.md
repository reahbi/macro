# Excel 탭 개선 계획 (수정본)

## 개요
기존 Excel 탭의 복잡한 기능을 단순화하고, 사용자가 더 직관적으로 Excel 데이터를 매크로와 연동할 수 있도록 개선합니다.
프로젝트 단위 저장 방식 대신 Excel 파일에 직접 작업 상태를 기록하는 방식으로 변경하여 더 간단하고 직관적인 사용 경험을 제공합니다.

## 주요 개선 사항

### 1. UI 간소화 및 명확성 개선

#### 1.1 시트 매핑 테이블 개선
- **제거할 항목**
  - "사용" 체크박스
  - "필수" 체크박스
  
- **개선 사항**
  - 단일 체크박스로 통합 (열 선택)
  - 변수명 자동 생성 기능 강화
    - 한글 → 영문 자동 변환
    - 특수문자 제거 및 언더스코어 변환
    - 예: "환자명" → "patient_name"
  - 데이터 타입 자동 감지 정확도 향상

#### 1.2 매핑 적용 → 에디터 자동 전환
매핑 적용 버튼 클릭 시 자동 워크플로우:
1. 선택된 열들을 변수로 매핑
2. 자동으로 에디터 탭으로 전환
3. Excel 루프 스텝 자동 생성
4. 매핑된 변수 사용 준비 완료

### 2. Excel 파일 기반 상태 관리

#### 2.1 상태 컬럼 자동 추가
Excel 파일에 작업 상태를 저장하는 방식:
- **자동 컬럼 추가**: "매크로_상태", "매크로_실행시간", "매크로_오류메시지" 컬럼 자동 생성
- **기존 컬럼 감지**: 이미 상태 컬럼이 있으면 재사용
- **컬럼 위치**: 기존 데이터의 맨 끝에 추가

#### 2.2 상태 값 정의
```
매크로_상태:
- (빈 값): 미처리
- "처리중": 현재 실행 중
- "완료": 성공적으로 완료
- "오류": 실행 중 오류 발생

매크로_실행시간:
- 마지막 실행 시간 (예: 2024-01-20 14:30:25)

매크로_오류메시지:
- 오류 발생 시 상세 메시지
```

#### 2.3 Excel 버전 호환성
**지원 버전**:
- Excel 2007 이상 (.xlsx 형식)
- Excel 97-2003 (.xls 형식) - 제한적 지원

**호환성 보장 방법**:
- pandas와 openpyxl 라이브러리 사용
- 기본 셀 포맷만 사용 (특수 포맷 배제)
- 수식이나 매크로 사용하지 않음
- 단순 텍스트/숫자 데이터만 추가

#### 2.4 안전 장치
- **백업 파일 생성**: 원본_backup_날짜시간.xlsx
- **실시간 저장 옵션**: 각 행 완료 시 즉시 저장 or 전체 완료 후 저장
- **읽기 전용 모드**: 원본 수정 없이 별도 결과 파일 생성 옵션

### 3. 완료 상태 관리 개선

#### 3.1 실행 상태 종류
- **대기중**: 아직 처리되지 않음
- **처리중**: 현재 실행 중
- **완료**: 성공적으로 완료
- **오류**: 실행 중 오류 발생

#### 3.2 상태 저장 방식
- **메모리**: 실시간 상태 추적
- **Excel 파일**: 직접 저장 (기본 방식)
- **자동 저장 옵션**: 
  - 즉시 저장: 각 행 처리 후 바로 저장
  - 배치 저장: 전체 완료 후 한 번에 저장
  - 주기적 저장: N개 행마다 저장

#### 3.3 필터 옵션
- "완료된 항목 숨기기" (기본값)
- "오류 항목만 표시"
- "대기 중인 항목만 표시"
- "전체 보기"

### 4. 구현 계획

#### 4.1 수정할 파일

**sheet_mapper.py**
- ColumnMappingTable 클래스 수정
  - "사용", "필수" 컬럼 제거
  - 단일 선택 체크박스로 변경
- 변수명 자동 생성 로직 개선

**excel_widget.py**
- 매핑 적용 시 에디터 탭 자동 전환
- Excel 상태 컬럼 자동 추가/업데이트

**excel_manager.py**
- 상태 컬럼 관리 메서드 추가
  - `add_status_columns()`: 상태 컬럼 자동 추가
  - `update_row_status()`: 행 상태 업데이트
  - `create_backup()`: 백업 파일 생성
- Excel 버전 호환성 체크

**main_window.py**
- 저장 옵션 설정 메뉴 추가
  - 자동 저장 방식 선택
  - 백업 설정
- 매크로 저장/불러오기는 기존 방식 유지

### 5. 사용자 경험 개선

#### 5.1 직관적인 워크플로우
1. Excel 파일 선택
2. 시트 선택
3. 사용할 열 체크
4. "매핑 적용" 클릭
5. 자동으로 에디터로 이동
6. 바로 실행 가능

#### 5.2 Excel 기반 작업 관리
- Excel 파일에 모든 상태 정보 포함
- 파일을 열면 이전 작업 상태 확인 가능
- 팀원과 Excel 파일 공유로 협업 가능
- 별도 프로젝트 파일 불필요

#### 5.3 상태 시각화
- 진행률 표시 (완료/전체)
- 오류 발생 행 하이라이트
- 실시간 상태 업데이트

### 6. Excel 버전별 호환성 고려사항

#### 6.1 완벽 지원
- **Excel 2007-2021, Office 365**: .xlsx 형식 완벽 지원
- **LibreOffice Calc**: 기본 기능 모두 지원
- **Google Sheets**: 가져오기/내보내기 시 호환

#### 6.2 제한적 지원
- **Excel 97-2003**: .xls 형식, 65,536행 제한
- **Excel for Mac**: 일부 경로 처리 차이

#### 6.3 주의사항
- 수식이나 피벗 테이블이 있는 경우 데이터만 유지
- 조건부 서식은 상태 컬럼에 영향받지 않음
- 매크로(VBA)가 있어도 충돌하지 않음

### 7. 예상 효과

- **작업 시간 단축**: 반복 설정 불필요
- **오류 감소**: 자동 매핑 및 타입 감지
- **협업 개선**: Excel 파일만으로 상태 공유
- **작업 연속성**: Excel 파일에서 바로 확인
- **데이터 무결성**: 작업 결과가 원본에 직접 기록
- **버전 관리 간소화**: 별도 프로젝트 파일 없이 Excel만으로 관리

### 8. UI 리뉴얼 - 데이터 중심 디자인

#### 8.1 현재 문제점
- **공간 활용 비효율**: 3단 수직 분할로 데이터 영역이 60% 미만
- **데이터 가시성 부족**: Excel 데이터를 충분히 보기 어려움
- **불필요한 UI 요소**: 프로젝트 버튼, 워크플로우 모드 선택 등

#### 8.2 새로운 레이아웃
```
┌─────────────────────────────────────────────────┐
│  [파일선택] [시트:Sheet1▼] [매핑설정▶] [필터▼]   │ <- 툴바 (40px)
├─────────────────────────────────────────────────┤
│                                                 │
│              Excel 데이터 테이블                 │ <- 메인영역 (90%)
│         (상태 컬럼 통합, 색상 코딩)              │
│                                                 │
├─────────────────────────────────────────────────┤
│ 진행: 45/100 (45%) | 완료:40 오류:5 | [실행▶]  │ <- 상태바 (30px)
└─────────────────────────────────────────────────┘
```

#### 8.3 주요 개선사항
- **데이터 영역 확대**: 전체 화면의 85-90% 차지
- **상태 시각화**: 행별 색상 코딩 (완료:녹색, 오류:빨강, 처리중:노랑)
- **컴팩트 툴바**: 파일/시트 선택을 한 줄로 통합
- **숨김 가능한 사이드 패널**: 매핑 설정 시에만 표시
- **통합 상태바**: 진행률과 실행 컨트롤 통합

#### 8.4 제거할 요소
- 워크플로우 모드 선택 다이얼로그
- 프로젝트 관련 버튼들
- 수직 3단 분할 레이아웃
- "사용", "필수" 체크박스

### 9. 구현 우선순위

1. **Phase 1**: UI 리뉴얼 및 간소화 (1.5주)
   - 데이터 중심 레이아웃 구현
   - 컴팩트 툴바 및 상태바
   - 워크플로우 모드 선택 제거
   - 시트 매핑 테이블 개선

2. **Phase 2**: Excel 상태 관리 (1주)
   - 상태 컬럼 자동 추가
   - 행별 색상 코딩
   - 백업 기능 구현
   - 저장 옵션 설정

3. **Phase 3**: 상태 필터링 및 시각화 (1주)
   - 완료 상태 추적
   - 필터 기능 강화
   - 진행률 표시
   - 오류 상세 정보 툴팁

4. **Phase 4**: 통합 테스트 및 최적화 (0.5주)
   - 전체 워크플로우 테스트
   - 성능 최적화
   - 반응형 디자인 검증